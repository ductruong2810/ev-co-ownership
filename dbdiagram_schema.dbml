// EV Co-ownership Database Schema (Simplified, no Dispute modules)

Table Roles {
  RoleId bigint [pk, increment]
  RoleName varchar(30) [unique, not null]
}

Table Users {
  UserId bigint [pk, increment]
  FullName varchar(100) [not null]
  Email varchar(100) [unique, not null]
  PasswordHash varchar(255) [not null]
  PhoneNumber varchar(20)
  AvatarUrl varchar(500)
  RoleId bigint [ref: > Roles.RoleId]
  Status varchar(20) [default: 'ACTIVE']
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
}

Table OwnershipGroup {
  GroupId bigint [pk, increment]
  GroupName varchar(100) [not null, unique]
  Status varchar(20) [default: 'PENDING']
  Description text
  MemberCapacity int [note: 'Planned number of members in the group']
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
}

Table OwnershipShare {
  UserId bigint [ref: > Users.UserId, not null]
  GroupId bigint [ref: > OwnershipGroup.GroupId, not null]
  GroupRole varchar(50) [default: 'MEMBER']
  OwnershipPercentage decimal(5,2) [not null, note: 'Must be > 0 and <= 100']
  JoinDate datetime [default: `now()`]
  DepositStatus varchar(20) [default: 'PENDING', note: 'PENDING, PAID, REFUNDED']
  UpdatedAt datetime [default: `now()`]

  indexes {
    (UserId, GroupId) [pk]
    GroupId [name: 'IX_OwnershipShare_GroupId']
  }
}

Table Vehicle {
  VehicleId bigint [pk, increment]
  Brand varchar(100)
  Model varchar(100)
  LicensePlate varchar(20)
  ChassisNumber varchar(30)
  QrCode varchar(255)
  VehicleValue decimal(15,2)
  GroupId bigint [ref: - OwnershipGroup.GroupId]
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
}

Table VehicleImages {
  ImageId bigint [pk, increment]
  VehicleId bigint [ref: > Vehicle.VehicleId, not null]
  ImageUrl varchar(500) [not null]
  ImageType varchar(20) [not null]
  ApprovalStatus varchar(20) [default: 'PENDING']
  ApprovedBy bigint [ref: > Users.UserId]
  ApprovedAt datetime
  RejectionReason varchar(500)
  UploadedAt datetime [default: `now()`]
}

Table Contract {
  ContractId bigint [pk, increment]
  GroupId bigint [ref: - OwnershipGroup.GroupId, not null]
  StartDate date
  EndDate date
  Terms text
  RequiredDepositAmount decimal(15,2)
  IsActive boolean [default: true]
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
  ApprovalStatus varchar(20) [default: 'PENDING']
  ApprovedBy bigint [ref: > Users.UserId]
  ApprovedAt datetime
  RejectionReason varchar(500)

  indexes {
    ApprovalStatus [name: 'IX_Contract_ApprovalStatus']
    ApprovedBy [name: 'IX_Contract_ApprovedBy']
  }
}

Table SharedFund {
  FundId bigint [pk, increment]
  GroupId bigint [ref: - OwnershipGroup.GroupId, not null]
  Balance decimal(15,2) [default: 0]
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
  Version bigint [default: 0]

  indexes {
    GroupId [unique, name: 'UQ_SharedFund_Group']
  }
}

Table UsageBooking {
  BookingId bigint [pk, increment]
  UserId bigint [ref: > Users.UserId, not null]
  VehicleId bigint [ref: > Vehicle.VehicleId, not null]
  StartDateTime datetime [not null]
  EndDateTime datetime [not null]
  Status varchar(20) [default: 'PENDING']
  TotalDuration int
  Priority int
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
}

Table Maintenance {
  MaintenanceId bigint [pk, increment]
  VehicleId bigint [ref: > Vehicle.VehicleId, not null]
  RequestedBy bigint [not null]
  ApprovedBy bigint [ref: > Users.UserId]
  RequestDate datetime [default: `now()`]
  ApprovalDate datetime
  NextDueDate date
  Description text
  EstimatedCost decimal(12,2)
  ActualCost decimal(12,2)
  MaintenanceStatus varchar(20) [default: 'PENDING']
}

Table Notification {
  NotificationId bigint [pk, increment]
  UserId bigint [ref: > Users.UserId]
  Title varchar(255)
  Message text
  NotificationType varchar(50)
  IsRead boolean [default: false]
  IsDelivered boolean [default: false]
  CreatedAt datetime [default: `now()`]
}

Table Incident {
  IncidentId bigint [pk, increment]
  BookingId bigint [ref: > UsageBooking.BookingId, not null]
  IncidentType varchar(50)
  Description text
  EstimatedCost decimal(12,2)
  ActualCost decimal(12,2)
  Status varchar(20) [default: 'REPORTED']
  ImageUrls text
  IncidentDate datetime [default: `now()`]
  ResolvedDate datetime
  ResolvedBy bigint [ref: > Users.UserId]
  Notes varchar(1000)
  CreatedAt datetime [default: `now()`]
}

Table VehicleCheck {
  Id bigint [pk, increment]
  BookingId bigint [ref: > UsageBooking.BookingId]
  CheckType varchar(20)
  Odometer int
  BatteryLevel decimal(5,2)
  Cleanliness varchar(20)
  Notes text
  Issues text
  Status varchar(20)
  CreatedAt datetime [default: `now()`]
}

Table UserDocument {
  DocumentId bigint [pk, increment]
  UserId bigint [not null]
  DocumentType varchar(20)
  Side varchar(10)
  ImageUrl varchar(500) [not null]
  Status varchar(20) [default: 'PENDING']
  ReviewNote text
  ReviewedBy bigint [ref: > Users.UserId]
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]
}

Table Voting {
  VotingId bigint [pk, increment]
  GroupId bigint [ref: > OwnershipGroup.GroupId]
  Title varchar(255)
  Description text
  VotingType varchar(50)
  Options text
  Results text
  Deadline datetime
  Status varchar(20) [default: 'ACTIVE']
  CreatedBy bigint [ref: > Users.UserId]
  CreatedAt datetime [default: `now()`]
}

Table Expense {
  ExpenseId bigint [pk, increment]
  FundId bigint [ref: > SharedFund.FundId]
  SourceType varchar(50)
  SourceId bigint
  Description text
  Amount decimal(12,2) [not null]
  ExpenseDate datetime [default: `now()`]
}

Table Payment {
  PaymentId bigint [pk, increment]
  PayerUserId bigint [ref: > Users.UserId, not null]
  FundId bigint [ref: > SharedFund.FundId, not null]
  Amount decimal(12,2) [not null]
  PaymentDate datetime [default: `now()`]
  PaymentMethod varchar(50)
  Status varchar(20) [default: 'PENDING']
  TransactionCode varchar(100)
  ProviderResponse text
  PaymentType varchar(20) [not null]
  Version bigint [default: 0]
  PaymentCategory varchar(20) [default: 'GROUP']
  ChargedUserId bigint [ref: > Users.UserId]
  PersonalReason text

  indexes {
    PaymentCategory [name: 'IX_Payment_Category']
    ChargedUserId [name: 'IX_Payment_ChargedUserId']
  }
}

Table FinancialReport {
  ReportId bigint [pk, increment]
  FundId bigint [ref: > SharedFund.FundId, not null]
  ReportMonth int
  ReportYear int
  TotalIncome decimal(15,2)
  TotalExpense decimal(15,2)
  GeneratedBy bigint [ref: > Users.UserId, not null]
  CreatedAt datetime [default: `now()`]
  UpdatedAt datetime [default: `now()`]

  indexes {
    FundId [name: 'IX_FinancialReport_FundId']
    (ReportYear, ReportMonth) [name: 'IX_FinancialReport_ReportYear_Month']
  }
}

Table OtpToken {
  TokenId bigint [pk, increment]
  Email varchar(100) [not null]
  OtpCode varchar(6) [not null]
  ExpiresAt datetime [not null]
  IsUsed boolean [default: false]
  CreatedAt datetime [default: `now()`]
}

Table Invitation {
  InvitationId bigint [pk, increment]
  GroupId bigint [ref: > OwnershipGroup.GroupId, not null]
  InviterUserId bigint [ref: > Users.UserId, not null]
  InviteeEmail varchar(100) [not null]
  Token varchar(128) [not null, unique]
  OtpCode varchar(6) [not null]
  Status varchar(20) [default: 'PENDING']
  SuggestedPercentage decimal(5,2)
  ExpiresAt datetime [not null]
  ResendCount int [default: 0]
  LastSentAt datetime
  CreatedAt datetime [default: `now()`]
  AcceptedAt datetime
  AcceptedBy bigint [ref: > Users.UserId]
}
