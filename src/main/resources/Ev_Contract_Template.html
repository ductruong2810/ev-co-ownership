<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Há»£p Ä‘á»“ng Sá»Ÿ há»¯u Xe Chung â€¢ EVShare</title>
    <style>
        :root {
            --ink: #111827;
            --muted: #6b7280;
            --primary: #0ea5e9;
            --border: #e5e7eb;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            color: var(--ink);
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 12px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .btn {
            border: 1px solid var(--border);
            background: white;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn.primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary)
        }

        .btn:active {
            transform: translateY(1px)
        }

        .page {
            max-width: 900px;
            margin: 24px auto;
            background: white;
            padding: 40px 48px;
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06)
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            letter-spacing: 0
        }

        .logo-mark {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #22d3ee, #3b82f6)
        }

        h1 {
            margin: 8px 0 0;
            font-size: 26px;
            line-height: 1.25
        }

        .subtitle {
            color: var(--muted)
        }

        .meta, .section > h2 {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .grid {
            display: grid;
            grid-template-columns:repeat(12, 1fr);
            gap: 16px
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px
        }

        .kvs {
            display: grid;
            grid-template-columns:180px 1fr;
            row-gap: 10px;
            column-gap: 12px
        }

        .key {
            color: var(--muted)
        }

        .val {
            font-weight: 600
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            text-align: left
        }

        th {
            background: #fafafa;
            font-size: 14px
        }

        .section {
            margin-top: 24px
        }

        .section > h2 {
            font-size: 18px;
            margin: 0 0 10px
        }

        .muted {
            color: var(--muted)
        }

        .signatures {
            display: grid;
            grid-template-columns:repeat(2, 1fr);
            gap: 24px
        }

        .sig-line {
            margin-top: 40px;
            border-top: 1px solid var(--border);
            padding-top: 6px;
            font-weight: 600
        }

        .footnote {
            margin-top: 24px;
            font-size: 12px;
            color: var(--muted)
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #e0e7ff
        }

        .right {
            text-align: right
        }

        .nowrap {
            white-space: nowrap
        }

        .break-avoid {
            break-inside: avoid
        }

        @media print {
            .toolbar {
                display: none
            }

            body {
                background: white
            }

            .page {
                box-shadow: none;
                border: none;
                margin: 0;
                border-radius: 0;
                page-break-after: always
            }

            a[href]:after {
                content: ""
            }
        }

        /* Styles cho Ä‘áº¡i diá»‡n kÃ½ */
        .signed-notice {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .signed-notice h3 {
            color: #0c4a6e;
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .signed-notice p {
            margin: 8px 0;
            color: #0c4a6e;
        }

        .proxy-signature-info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .proxy-signature-info h4 {
            color: #92400e;
            margin: 0 0 10px 0;
        }

        .proxy-signature-info ul {
            margin: 10px 0;
            padding-left: 20px;
            color: #92400e;
        }

        .sign-button-proxy {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
        }

        .sign-button-proxy:hover {
            background: #b91c1c;
        }

        /* Styles cho Ä‘Ã³ng tiá»n cá»c */
        .deposit-info {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .deposit-info h3 {
            color: #166534;
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .deposit-info p {
            margin: 8px 0;
            color: #166534;
        }

        .pay-button {
            background: #22c55e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }

        .pay-button:hover {
            background: #16a34a;
        }

        .status-pending {
            color: #f59e0b;
            font-weight: 600;
        }

        .status-paid {
            color: #22c55e;
            font-weight: 600;
        }

        .status-refunded {
            color: #6b7280;
            font-weight: 600;
        }

        .deposit-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .member-deposit-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .member-deposit-card h4 {
            margin: 0 0 10px 0;
            color: #374151;
        }

        .member-deposit-card .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .member-deposit-card .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .member-deposit-card .status.paid {
            background: #dcfce7;
            color: #166534;
        }
    </style>
</head>
<body>
<!-- Top toolbar (won't print) -->
<div class="toolbar">
    <button class="btn" onclick="fillDemo()">âœ¨ Äá»• dá»¯ liá»‡u máº«u</button>
    <button class="btn" onclick="loadContractData(1)">ğŸ“„ Load tá»« Server</button>
    <button class="btn primary sign-button-proxy" id="sign-button" onclick="signContract()">âœ… KÃ½ há»£p Ä‘á»“ng (Äáº¡i diá»‡n cho
        táº¥t cáº£ thÃ nh viÃªn)
    </button>
    <button class="btn" onclick="checkDepositStatus()">ğŸ’° Kiá»ƒm tra tiá»n cá»c</button>
    <button class="btn" onclick="clearAll()">â™»ï¸ XÃ³a dá»¯ liá»‡u</button>
    <span class="muted">Máº¹o: Admin Group cÃ³ thá»ƒ kÃ½ thay cho táº¥t cáº£ thÃ nh viÃªn.</span>
</div>

<!-- ThÃ´ng tin Ä‘áº¡i diá»‡n kÃ½ -->
<div id="signed-info" style="display: none;"></div>

<!-- ThÃ´ng tin tiá»n cá»c -->
<div id="deposit-status"></div>

<!-- ThÃ´ng tin phÃ¡p lÃ½ vá» Ä‘áº¡i diá»‡n kÃ½ -->
<div class="proxy-signature-info">
    <h4>ğŸ“‹ ThÃ´ng tin vá» Ä‘áº¡i diá»‡n kÃ½</h4>
    <ul>
        <li><strong>Quyá»n Ä‘áº¡i diá»‡n:</strong> Admin Group cÃ³ quyá»n kÃ½ há»£p Ä‘á»“ng thay cho táº¥t cáº£ thÃ nh viÃªn</li>
        <li><strong>GiÃ¡ trá»‹ phÃ¡p lÃ½:</strong> Chá»¯ kÃ½ Ä‘áº¡i diá»‡n cÃ³ giÃ¡ trá»‹ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i chá»¯ kÃ½ cá»§a tá»«ng thÃ nh viÃªn</li>
        <li><strong>TrÃ¡ch nhiá»‡m:</strong> Admin Group chá»‹u trÃ¡ch nhiá»‡m vá» viá»‡c kÃ½ há»£p Ä‘á»“ng</li>
        <li><strong>ThÃ´ng bÃ¡o:</strong> Táº¥t cáº£ thÃ nh viÃªn sáº½ Ä‘Æ°á»£c thÃ´ng bÃ¡o vá» viá»‡c kÃ½ há»£p Ä‘á»“ng</li>
    </ul>
</div>

<!-- ThÃ´ng tin vá» tiá»n cá»c -->
<div class="proxy-signature-info">
    <h4>ğŸ’° ThÃ´ng tin vá» tiá»n cá»c</h4>
    <ul>
        <li><strong>Äiá»u kiá»‡n:</strong> Chá»‰ cÃ³ thá»ƒ Ä‘Ã³ng tiá»n cá»c sau khi contract Ä‘Ã£ Ä‘Æ°á»£c kÃ½</li>
        <li><strong>Sá»‘ tiá»n:</strong> Theo quy Ä‘á»‹nh trong contract (thÆ°á»ng lÃ  2-5 triá»‡u VND)</li>
        <li><strong>PhÆ°Æ¡ng thá»©c:</strong> Thanh toÃ¡n qua VNPay</li>
        <li><strong>KÃ­ch hoáº¡t:</strong> Group sáº½ Ä‘Æ°á»£c kÃ­ch hoáº¡t khi táº¥t cáº£ thÃ nh viÃªn Ä‘Ã£ Ä‘Ã³ng tiá»n cá»c</li>
    </ul>
</div>

<!-- A4-like page -->
<div class="page" id="contract">
    <header>
        <div class="logo">
            <div class="logo-mark" aria-hidden="true"></div>
            <div>
                <div>EVShare</div>
                <div class="subtitle">Há»‡ thá»‘ng Ä‘á»“ng sá»Ÿ há»¯u xe Ä‘iá»‡n</div>
            </div>
        </div>
        <div class="right">
            <div class="badge" id="contract-status">DRAFT</div>
            <br/>
            <small class="muted">Sá»‘ há»£p Ä‘á»“ng: <span data-text="contract.number">â€”</span></small>
        </div>
    </header>

    <h1>Há»¢P Äá»’NG Sá» Há»®U XE CHUNG</h1>
    <div class="subtitle">CÄƒn cá»© theo thá»a thuáº­n giá»¯a cÃ¡c BÃªn thuá»™c NhÃ³m sá»Ÿ há»¯u <b data-text="group.name">â€”</b>.</div>

    <!-- Meta blocks -->
    <div class="grid" style="margin-top:16px">
        <div class="card break-avoid" style="grid-column: span 7">
            <div class="meta"><strong>ThÃ´ng tin phÆ°Æ¡ng tiá»‡n</strong></div>
            <div class="kvs" style="margin-top:10px">
                <div class="key">HÃ£ng / Model</div>
                <div class="val" data-text="vehicle.model">â€”</div>
                <div class="key">Biá»ƒn sá»‘</div>
                <div class="val" data-text="vehicle.plate">â€”</div>
                <div class="key">Sá»‘ VIN</div>
                <div class="val" data-text="vehicle.vin">â€”</div>
            </div>
        </div>
        <div class="card break-avoid" style="grid-column: span 5">
            <div class="meta"><strong>Hiá»‡u lá»±c há»£p Ä‘á»“ng</strong></div>
            <div class="kvs" style="margin-top:10px">
                <div class="key">NgÃ y hiá»‡u lá»±c</div>
                <div class="val" data-text="contract.effectiveDate">â€”</div>
                <div class="key">NgÃ y káº¿t thÃºc</div>
                <div class="val" data-text="contract.endDate">â€”</div>
                <div class="key">Ká»³ háº¡n</div>
                <div class="val" data-text="contract.termLabel">â€”</div>
            </div>
        </div>
    </div>

    <!-- Owners table -->
    <div class="section break-avoid">
        <h2>1. CÃ¡c BÃªn Ä‘á»“ng sá»Ÿ há»¯u</h2>
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>Há» tÃªn</th>
                <th>LiÃªn há»‡</th>
                <th>Giáº¥y tá»</th>
                <th class="right">Tá»· lá»‡ (%)</th>
            </tr>
            </thead>
            <tbody id="owners-tbody">
            <!-- injected rows -->
            </tbody>
        </table>
        <div class="muted" style="margin-top:6px">Tá»•ng tá»· lá»‡: <b><span id="ownership-sum">0</span>%</b></div>
    </div>

    <!-- Finance terms -->
    <div class="section">
        <h2>2. GÃ³p vá»‘n & Quá»¹ váº­n hÃ nh</h2>
        <div class="kvs" style="margin-top:6px">
            <div class="key">GiÃ¡ trá»‹ xe</div>
            <div class="val nowrap" data-text="finance.vehiclePrice">â€”</div>
            <div class="key">Tiá»n cá»c</div>
            <div class="val nowrap" data-text="finance.depositAmount">â€”</div>
            <div class="key">Má»¥c tiÃªu quá»¹</div>
            <div class="val nowrap" data-text="finance.targetAmount">â€”</div>
            <div class="key">NguyÃªn táº¯c gÃ³p</div>
            <div class="val" data-text="finance.contributionRule">â€”</div>
        </div>
        <p class="muted">CÃ¡c khoáº£n chi báº£o dÆ°á»¡ng, sáº¡c, vá»‡ sinhâ€¦ Ä‘Æ°á»£c thanh toÃ¡n tá»« Quá»¹ chung; khoáº£n cÃ¡ nhÃ¢n (náº¿u cÃ³) do
            cÃ¡ nhÃ¢n chi tráº£ theo bÃºt toÃ¡n bÃ¹ trá»«.</p>
        <p class="muted"><strong>LÆ°u Ã½:</strong> Tiá»n cá»c pháº£i Ä‘Æ°á»£c Ä‘Ã³ng Ä‘áº§y Ä‘á»§ trÆ°á»›c khi há»£p Ä‘á»“ng Ä‘Æ°á»£c kÃ­ch hoáº¡t vÃ  cÃ³
            hiá»‡u lá»±c.</p>
    </div>

    <!-- Usage & rules -->
    <div class="section">
        <h2>3. Quyá»n sá»­ dá»¥ng & Lá»‹ch Ä‘áº·t</h2>
        <p>Viá»‡c sá»­ dá»¥ng xe Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua há»‡ thá»‘ng Ä‘áº·t lá»‹ch. Quy táº¯c Æ°u tiÃªn: <span
                data-text="usage.rule">â€”</span>. Má»—i BÃªn cam káº¿t tuÃ¢n thá»§ lá»‹ch Ä‘áº·t vÃ  hoÃ n tráº£ Ä‘Ãºng háº¹n.</p>
    </div>

    <div class="section">
        <h2>4. Báº£o dÆ°á»¡ng, Sá»­a chá»¯a & Báº£o hiá»ƒm</h2>
        <p>Xe Ä‘Æ°á»£c báº£o dÆ°á»¡ng Ä‘á»‹nh ká»³ theo khuyáº¿n nghá»‹ cá»§a hÃ£ng. TrÃ¡ch nhiá»‡m phÃª duyá»‡t chi phÃ­: <span
                data-text="maintenance.approval">â€”</span>. Há»£p Ä‘á»“ng báº£o hiá»ƒm: <span
                data-text="maintenance.insurance">â€”</span>.</p>
    </div>

    <div class="section">
        <h2>5. Giáº£i quyáº¿t tranh cháº¥p</h2>
        <p>Tranh cháº¥p phÃ¡t sinh Ä‘Æ°á»£c ghi nháº­n trÃªn há»‡ thá»‘ng vÃ  Æ°u tiÃªn hÃ²a giáº£i trong NhÃ³m. CÆ¡ cháº¿ biá»ƒu quyáº¿t: <span
                data-text="dispute.voting">â€”</span>. Tháº©m quyá»n cuá»‘i cÃ¹ng theo phÃ¡p luáº­t hiá»‡n hÃ nh.</p>
    </div>

    <div class="section">
        <h2>6. Äiá»u khoáº£n chung</h2>
        <ul>
            <li>Há»£p Ä‘á»“ng cÃ³ hiá»‡u lá»±c khi táº¥t cáº£ BÃªn Ä‘á»“ng sá»Ÿ há»¯u Ä‘á»“ng Ã½ vÃ  kÃ½.</li>
            <li><strong>KÃ­ch hoáº¡t há»£p Ä‘á»“ng:</strong> Sau khi kÃ½, há»£p Ä‘á»“ng chá»‰ Ä‘Æ°á»£c kÃ­ch hoáº¡t khi táº¥t cáº£ thÃ nh viÃªn Ä‘Ã£
                Ä‘Ã³ng Ä‘á»§ tiá»n cá»c theo quy Ä‘á»‹nh.
            </li>
            <li><strong>Duyá»‡t há»£p Ä‘á»“ng:</strong> Há»‡ thá»‘ng sáº½ duyá»‡t láº¡i há»£p Ä‘á»“ng sau khi nháº­n Ä‘á»§ tiá»n cá»c tá»« táº¥t cáº£ thÃ nh
                viÃªn.
            </li>
            <li>CÃ¡c phá»¥ lá»¥c (náº¿u cÃ³) lÃ  bá»™ pháº­n khÃ´ng tÃ¡ch rá»i cá»§a Há»£p Ä‘á»“ng.</li>
            <li>Há»‡ thá»‘ng lÆ°u váº¿t phiÃªn báº£n, thá»i Ä‘iá»ƒm kÃ½ vÃ  danh tÃ­nh ngÆ°á»i kÃ½.</li>
        </ul>
    </div>

    <!-- Signatures -->
    <div class="section break-avoid">
        <h2>7. Chá»¯ kÃ½ cÃ¡c BÃªn</h2>
        <div id="signature-grid" class="signatures">
            <!-- signature boxes injected here -->
        </div>
        <div class="footnote">Khi kÃ½ Ä‘iá»‡n tá»­, má»—i Ã´ chá»¯ kÃ½ sáº½ hiá»ƒn thá»‹ tÃªn, thá»i gian kÃ½ vÃ  fingerprint cá»§a chá»¯ kÃ½.
        </div>
    </div>

    <div class="section" style="margin-top:28px">
        <div class="muted">Äá»‹a Ä‘iá»ƒm kÃ½: <span data-text="contract.location">â€”</span> Â· NgÃ y: <span
                data-text="contract.signDate">â€”</span></div>
    </div>
</div>

<script>
    // --- Tiny binding helper -------------------------------------------------
    function setText(selectorKey, value) {
        document.querySelectorAll(`[data-text="${selectorKey}"]`).forEach(el => el.textContent = value ?? 'â€”');
    }

    function fmtCurrency(v) {
        if (v == null) return 'â€”';
        try {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(v);
        } catch {
            return String(v);
        }
    }

    function render(data) {
        // Contract meta
        setText('contract.number', data.contract.number);
        setText('group.name', data.group.name);
        setText('vehicle.model', data.vehicle.model);
        setText('vehicle.plate', data.vehicle.plate);
        setText('vehicle.vin', data.vehicle.vin);
        setText('contract.effectiveDate', data.contract.effectiveDate);
        setText('contract.endDate', data.contract.endDate);
        setText('contract.termLabel', data.contract.termLabel);
        setText('contract.location', data.contract.location);
        setText('contract.signDate', data.contract.signDate);

        // Finance
        setText('finance.vehiclePrice', fmtCurrency(data.finance.vehiclePrice));
        setText('finance.depositAmount', fmtCurrency(data.finance.depositAmount));
        setText('finance.targetAmount', fmtCurrency(data.finance.targetAmount));
        setText('finance.fundAccount', data.finance.fundAccount);
        setText('finance.contributionRule', data.finance.contributionRule);

        // Usage / Maintenance / Dispute
        setText('usage.rule', data.usage.rule);
        setText('maintenance.approval', data.maintenance.approval);
        setText('maintenance.insurance', data.maintenance.insurance);
        setText('dispute.voting', data.dispute.voting);

        // Status badge
        const badge = document.getElementById('contract-status');
        badge.textContent = (data.contract.status || 'DRAFT').toUpperCase();

        // Owners
        const tbody = document.getElementById('owners-tbody');
        tbody.innerHTML = '';
        let sum = 0;
        (data.owners || []).forEach((o, i) => {
            sum += Number(o.share || 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${i + 1}</td>
          <td><strong>${o.name}</strong></td>
          <td>${o.phone || ''}${o.email ? ' Â· ' + o.email : ''}</td>
          <td>${o.idType || ''} ${o.idNo || ''}</td>
          <td class="right">${(o.share ?? 0)}%</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('ownership-sum').textContent = sum;

        // Signatures grid: only group admin
        const grid = document.getElementById('signature-grid');
        grid.innerHTML = '';
        const admin = (data.owners || [])[0];
        if (admin) {
            const box = document.createElement('div');
            box.className = 'sig-box';

            // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Ã£ kÃ½
            const isSigned = data.contract.status === 'SIGNED';
            const signatureText = isSigned ? 'âœ… ÄÃ£ kÃ½' : 'Chá»¯ kÃ½';
            const signatureStyle = isSigned ? 'color: #166534; font-weight: bold;' : '';

            box.innerHTML = `
          <div><strong>${admin.name}</strong></div>
          <div class="muted">Äáº¡i diá»‡n NhÃ³m (Admin)</div>
          <div class="sig-line" style="${signatureStyle}">${signatureText}</div>
          <div class="muted" style="font-size:12px">Tá»· lá»‡: ${admin.share ?? 0}%</div>`;
            grid.appendChild(box);
        }
    }

    // Function Ä‘á»ƒ load data tá»« server
    function loadContractData(groupId) {
        fetch(`/api/contracts/${groupId}`)
            .then(response => response.json())
            .then(data => {
                // Convert server data to template format
                const templateData = convertServerDataToTemplate(data);
                render(templateData);
            })
            .catch(error => {
                console.error('Error loading contract data:', error);
                // Fallback to demo data
                fillDemo();
            });
    }

    // Convert server data to template format
    function convertServerDataToTemplate(serverData) {
        return {
            contract: {
                number: serverData.contractNumber || 'EVS-001',
                effectiveDate: serverData.startDate || '2025-01-01',
                endDate: serverData.endDate || '2026-01-01',
                termLabel: '12 thÃ¡ng',
                location: 'HÃ  Ná»™i',
                signDate: new Date().toISOString().split('T')[0],
                status: serverData.isActive ? 'ACTIVE' : 'DRAFT'
            },
            group: {
                name: serverData.groupName || 'EVShare Group'
            },
            vehicle: {
                model: 'VinFast VF 8 Plus',
                plate: '30A-123.45',
                vin: 'RLVZZZ1EZBW000001'
            },
            finance: {
                vehiclePrice: 950000000,
                depositAmount: serverData.requiredDepositAmount || 2000000,
                targetAmount: 50000000,
                fundAccount: 'MB Bank 0123456789',
                contributionRule: 'Theo tá»· lá»‡ sá»Ÿ há»¯u'
            },
            usage: {
                rule: 'Äiá»ƒm tÃ­n dá»¥ng lá»‹ch sá»­ & phiÃªn bá»‘c thÄƒm tuáº§n'
            },
            maintenance: {
                approval: 'Biá»ƒu quyáº¿t > 50% theo tá»· lá»‡ sá»Ÿ há»¯u cho chi > 5 triá»‡u',
                insurance: 'PVI â€“ GÃ³i váº­t cháº¥t toÃ n diá»‡n'
            },
            dispute: {
                voting: 'Äa sá»‘ theo tá»· lá»‡ sá»Ÿ há»¯u; náº¿u hoÃ  50/50, Æ°u tiÃªn lá»‹ch sá»­ Ä‘Ã³ng gÃ³p'
            },
            owners: [
                {
                    name: 'Nguyá»…n VÄƒn A',
                    phone: '0901 234 567',
                    email: 'a@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678901',
                    share: 40
                },
                {
                    name: 'Tráº§n Thá»‹ B',
                    phone: '0902 234 567',
                    email: 'b@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678902',
                    share: 35
                },
                {
                    name: 'LÃª VÄƒn C',
                    phone: '0903 234 567',
                    email: 'c@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678903',
                    share: 25
                }
            ]
        };
    }

    // --- Demo & helpers ------------------------------------------------------
    function fillDemo() {
        const demo = {
            contract: {
                number: 'EVS-2025-001',
                effectiveDate: '2025-10-20',
                endDate: '2026-10-19',
                termLabel: '12 thÃ¡ng',

                status: 'Draft',
                location: 'HÃ  Ná»™i',
                signDate: '2025-10-20'
            },
            group: {name: 'EVShare â€“ NhÃ³m A'},
            vehicle: {model: 'VinFast VF 8 Plus', plate: '30A-123.45', vin: 'RLVZZZ1EZBW000001'},
            finance: {
                vehiclePrice: 950_000_000,
                depositAmount: 30_000_000,
                targetAmount: 50_000_000,
                fundAccount: 'MB Bank 0123456789 â€“ EVShare Group A',
                contributionRule: 'Theo tá»· lá»‡ sá»Ÿ há»¯u'
            },
            usage: {rule: 'Äiá»ƒm tÃ­n dá»¥ng lá»‹ch sá»­ & phiÃªn bá»‘c thÄƒm tuáº§n'},
            maintenance: {
                approval: 'Biá»ƒu quyáº¿t > 50% theo tá»· lá»‡ sá»Ÿ há»¯u cho chi > 5 triá»‡u',
                insurance: 'PVI â€“ GÃ³i váº­t cháº¥t toÃ n diá»‡n'
            },
            dispute: {voting: 'Äa sá»‘ theo tá»· lá»‡ sá»Ÿ há»¯u; náº¿u hoÃ  50/50, Æ°u tiÃªn lá»‹ch sá»­ Ä‘Ã³ng gÃ³p'},
            owners: [
                {
                    name: 'Nguyá»…n VÄƒn A',
                    phone: '0901 234 567',
                    email: 'a@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678901',
                    share: 40
                },
                {
                    name: 'Tráº§n Thá»‹ B',
                    phone: '0902 234 567',
                    email: 'b@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678902',
                    share: 35
                },
                {
                    name: 'LÃª VÄƒn C',
                    phone: '0903 234 567',
                    email: 'c@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678903',
                    share: 25
                }
            ]
        };
        render(demo);
    }

    // Function Ä‘á»ƒ kÃ½ há»£p Ä‘á»“ng (Admin Group kÃ½ thay táº¥t cáº£ Members)
    function signContract() {
        if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n kÃ½ há»£p Ä‘á»“ng nÃ y thay cho táº¥t cáº£ thÃ nh viÃªn? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.')) {
            // Láº¥y groupId tá»« URL hoáº·c tá»« data hiá»‡n táº¡i
            const groupId = getCurrentGroupId();

            // Láº¥y thÃ´ng tin admin hiá»‡n táº¡i
            const adminName = getCurrentAdminName();

            // Gá»i API Ä‘á»ƒ kÃ½ há»£p Ä‘á»“ng vá»›i Ä‘áº¡i diá»‡n
            fetch(`/api/contracts/${groupId}/sign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    signedAt: new Date().toISOString(),
                    signature: 'Digital signature by admin',
                    adminName: adminName,
                    signatureType: 'ADMIN_PROXY',
                    reason: 'Admin Group kÃ½ thay táº¥t cáº£ thÃ nh viÃªn theo quy Ä‘á»‹nh'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('âœ… Há»£p Ä‘á»“ng Ä‘Ã£ Ä‘Æ°á»£c kÃ½ thÃ nh cÃ´ng!\n' +
                            'NgÆ°á»i kÃ½: ' + data.signedBy + '\n' +
                            'Loáº¡i kÃ½: ' + data.signatureType + '\n' +
                            'Thá»i gian: ' + new Date(data.signedAt).toLocaleString());
                        // Cáº­p nháº­t UI Ä‘á»ƒ hiá»ƒn thá»‹ tráº¡ng thÃ¡i Ä‘Ã£ kÃ½
                        updateContractStatus('SIGNED');
                        // Reload data Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i
                        loadContractData(groupId);
                    } else {
                        alert('âŒ CÃ³ lá»—i xáº£y ra khi kÃ½ há»£p Ä‘á»“ng: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error signing contract:', error);
                    alert('âŒ CÃ³ lá»—i xáº£y ra khi kÃ½ há»£p Ä‘á»“ng. Vui lÃ²ng thá»­ láº¡i.');
                });
        }
    }

    // Function Ä‘á»ƒ láº¥y tÃªn admin hiá»‡n táº¡i
    function getCurrentAdminName() {
        // CÃ³ thá»ƒ láº¥y tá»« user info hoáº·c tá»« data hiá»‡n táº¡i
        const userInfo = getCurrentUserInfo();
        return userInfo ? userInfo.fullName : 'Admin Group';
    }

    // Function Ä‘á»ƒ láº¥y thÃ´ng tin user hiá»‡n táº¡i
    function getCurrentUserInfo() {
        // CÃ³ thá»ƒ láº¥y tá»« localStorage, sessionStorage hoáº·c tá»« API
        try {
            const userInfo = localStorage.getItem('userInfo');
            return userInfo ? JSON.parse(userInfo) : null;
        } catch (e) {
            return null;
        }
    }

    // Function Ä‘á»ƒ Ä‘Ã³ng tiá»n cá»c
    function payDeposit() {
        const groupId = getCurrentGroupId();
        const userId = getCurrentUserId();

        // Láº¥y thÃ´ng tin deposit
        fetch(`/api/deposits/info/${userId}/${groupId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.canPay) {
                    alert('âŒ Báº¡n khÃ´ng thá»ƒ Ä‘Ã³ng tiá»n cá»c:\n' +
                        '- Contract chÆ°a Ä‘Æ°á»£c kÃ½: ' + (data.contractSigned ? 'ÄÃ£ kÃ½' : 'ChÆ°a kÃ½') + '\n' +
                        '- Tráº¡ng thÃ¡i deposit: ' + data.depositStatus);
                    return;
                }

                const amount = data.requiredAmount;
                const confirmMessage = `Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Ã³ng tiá»n cá»c?\n\n` +
                    `Sá»‘ tiá»n: ${formatCurrency(amount)}\n` +
                    `PhÆ°Æ¡ng thá»©c: VNPay\n` +
                    `LÆ°u Ã½: Sau khi Ä‘Ã³ng tiá»n cá»c, báº¡n sáº½ trá»Ÿ thÃ nh thÃ nh viÃªn chÃ­nh thá»©c cá»§a group.`;

                if (confirm(confirmMessage)) {
                    createDepositPayment(userId, groupId, amount);
                }
            })
            .catch(error => {
                console.error('Error getting deposit info:', error);
                alert('âŒ CÃ³ lá»—i khi láº¥y thÃ´ng tin deposit. Vui lÃ²ng thá»­ láº¡i.');
            });
    }

    // Function Ä‘á»ƒ táº¡o payment vá»›i VNPay
    function createDepositPayment(userId, groupId, amount) {
        const request = {
            userId: userId,
            groupId: groupId,
            amount: amount,
            paymentMethod: 'VNPAY'
        };

        fetch('/api/deposits/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        })
            .then(response => response.json())
            .then(data => {
                if (data.paymentId && data.vnpayUrl) {
                    alert('âœ… Táº¡o payment thÃ nh cÃ´ng!\n' +
                        'Payment ID: ' + data.paymentId + '\n' +
                        'Sá»‘ tiá»n: ' + formatCurrency(data.amount) + '\n' +
                        'Tráº¡ng thÃ¡i: ' + data.status + '\n\n' +
                        'Äang chuyá»ƒn hÆ°á»›ng Ä‘áº¿n VNPay...');

                    // Redirect trá»±c tiáº¿p Ä‘áº¿n VNPay
                    window.location.href = data.vnpayUrl;
                } else {
                    alert('âŒ CÃ³ lá»—i khi táº¡o payment: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating deposit payment:', error);
                alert('âŒ CÃ³ lá»—i khi táº¡o payment. Vui lÃ²ng thá»­ láº¡i.');
            });
    }

    // Function Ä‘á»ƒ kiá»ƒm tra payment status sau khi quay láº¡i tá»« VNPay
    function checkPaymentStatusFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const responseCode = urlParams.get('vnp_ResponseCode');

        if (responseCode) {
            if (responseCode === '00') {
                alert('ğŸ‰ Thanh toÃ¡n thÃ nh cÃ´ng!\n' +
                    'Tiá»n cá»c Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng thÃ nh cÃ´ng.\n' +
                    'Group sáº½ Ä‘Æ°á»£c kÃ­ch hoáº¡t khi táº¥t cáº£ thÃ nh viÃªn Ä‘Ã£ Ä‘Ã³ng tiá»n cá»c.');

                // Reload Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                alert('âŒ Thanh toÃ¡n tháº¥t báº¡i!\n' +
                    'MÃ£ lá»—i: ' + responseCode + '\n' +
                    'Vui lÃ²ng thá»­ láº¡i.');
            }
        }
    }

    // Function Ä‘á»ƒ kiá»ƒm tra tráº¡ng thÃ¡i deposit
    function checkDepositStatus() {
        const groupId = getCurrentGroupId();
        const userId = getCurrentUserId();

        fetch(`/api/deposits/info/${userId}/${groupId}`)
            .then(response => response.json())
            .then(data => {
                updateDepositStatusUI(data);

                // Náº¿u Ä‘Ã£ Ä‘Ã³ng tiá»n cá»c, kiá»ƒm tra group activation
                if (data.depositStatus === 'PAID') {
                    checkGroupActivation(groupId);
                }
            })
            .catch(error => {
                console.error('Error checking deposit status:', error);
            });
    }

    // Function Ä‘á»ƒ cáº­p nháº­t UI tráº¡ng thÃ¡i deposit
    function updateDepositStatusUI(data) {
        const depositStatusElement = document.getElementById('deposit-status');
        if (depositStatusElement) {
            depositStatusElement.innerHTML = `
                <div class="deposit-info">
                    <h3>ğŸ’° ThÃ´ng tin tiá»n cá»c</h3>
                    <p><strong>Tá»· lá»‡ sá»Ÿ há»¯u:</strong> ${data.ownershipPercentage || 0}%</p>
                    <p><strong>Sá»‘ tiá»n cáº§n Ä‘Ã³ng:</strong> ${formatCurrency(data.requiredAmount)}</p>
                    <p><strong>Tráº¡ng thÃ¡i:</strong> 
                        <span class="status-${data.depositStatus.toLowerCase()}">${getDepositStatusText(data.depositStatus)}</span>
                    </p>
                    <p><strong>Contract Ä‘Ã£ kÃ½:</strong> ${data.contractSigned ? 'âœ… CÃ³' : 'âŒ ChÆ°a'}</p>
                    <p class="muted"><small>ğŸ’¡ Tiá»n cá»c Ä‘Æ°á»£c tÃ­nh theo tá»· lá»‡ sá»Ÿ há»¯u cá»§a báº¡n</small></p>
                    ${data.canPay ? '<button onclick="payDeposit()" class="pay-button">ğŸ’³ ÄÃ³ng tiá»n cá»c</button>' : ''}
                </div>
            `;
        }
    }

    // Function Ä‘á»ƒ kiá»ƒm tra group activation
    function checkGroupActivation(groupId) {
        fetch(`/api/deposits/group/${groupId}/status`)
            .then(response => response.json())
            .then(data => {
                const allPaid = data.every(member => member.depositStatus === 'PAID');

                if (allPaid) {
                    alert('ğŸ‰ Táº¥t cáº£ thÃ nh viÃªn Ä‘Ã£ Ä‘Ã³ng tiá»n cá»c!\n' +
                        'Group sáº½ Ä‘Æ°á»£c kÃ­ch hoáº¡t tá»± Ä‘á»™ng.');

                    // Reload page Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking group activation:', error);
            });
    }

    // Function Ä‘á»ƒ láº¥y user ID hiá»‡n táº¡i
    function getCurrentUserId() {
        // CÃ³ thá»ƒ láº¥y tá»« localStorage, sessionStorage hoáº·c tá»« API
        try {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                return user.userId || user.id;
            }
        } catch (e) {
            console.error('Error getting user info:', e);
        }
        return 1; // Default for demo
    }

    // Function Ä‘á»ƒ format currency
    function formatCurrency(amount) {
        if (!amount) return '0 VND';
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    // Function Ä‘á»ƒ láº¥y text tráº¡ng thÃ¡i deposit
    function getDepositStatusText(status) {
        switch (status) {
            case 'PENDING':
                return 'â³ ChÆ°a Ä‘Ã³ng';
            case 'PAID':
                return 'âœ… ÄÃ£ Ä‘Ã³ng';
            case 'REFUNDED':
                return 'ğŸ”„ ÄÃ£ hoÃ n';
            default:
                return 'â“ KhÃ´ng xÃ¡c Ä‘á»‹nh';
        }
    }

    // Function Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i contract trÃªn UI
    function updateContractStatus(status) {
        const statusElement = document.getElementById('contract-status');
        if (statusElement) {
            statusElement.textContent = status;
            statusElement.className = 'status-' + status.toLowerCase();
        }

        // áº¨n nÃºt kÃ½ náº¿u Ä‘Ã£ kÃ½
        const signButton = document.getElementById('sign-button');
        if (signButton && status === 'SIGNED') {
            signButton.style.display = 'none';

            // Hiá»ƒn thá»‹ thÃ´ng tin Ä‘Ã£ kÃ½
            const signedInfo = document.getElementById('signed-info');
            if (signedInfo) {
                signedInfo.style.display = 'block';
                signedInfo.innerHTML = `
                    <div class="signed-notice">
                        <h3>âœ… Há»£p Ä‘á»“ng Ä‘Ã£ Ä‘Æ°á»£c kÃ½</h3>
                        <p><strong>NgÆ°á»i kÃ½:</strong> Admin Group (Äáº¡i diá»‡n cho táº¥t cáº£ thÃ nh viÃªn)</p>
                        <p><strong>Thá»i gian:</strong> <span id="signed-time">Äang táº£i...</span></p>
                        <p><strong>Loáº¡i kÃ½:</strong> Äáº¡i diá»‡n phÃ¡p lÃ½</p>
                    </div>
                `;

                // Cáº­p nháº­t thá»i gian kÃ½
                const signedTimeElement = document.getElementById('signed-time');
                if (signedTimeElement) {
                    signedTimeElement.textContent = new Date().toLocaleString();
                }
            }
        }
    }

    // Auto demo on first load for preview
    fillDemo();

    // Kiá»ƒm tra payment status tá»« URL khi load page
    checkPaymentStatusFromUrl();
</script>
</body>
</html>
