<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>H·ª£p ƒë·ªìng S·ªü h·ªØu Xe Chung ‚Ä¢ EVShare</title>
    <style>
        :root {
            --ink: #111827;
            --muted: #6b7280;
            --primary: #0ea5e9;
            --border: #e5e7eb;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            color: var(--ink);
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 12px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .btn {
            border: 1px solid var(--border);
            background: white;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn.primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary)
        }

        .btn:active {
            transform: translateY(1px)
        }

        .page {
            max-width: 900px;
            margin: 24px auto;
            background: white;
            padding: 40px 48px;
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06)
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            letter-spacing: 0
        }

        .logo-mark {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #22d3ee, #3b82f6)
        }

        h1 {
            margin: 8px 0 0;
            font-size: 26px;
            line-height: 1.25
        }

        .subtitle {
            color: var(--muted)
        }

        .meta, .section > h2 {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .grid {
            display: grid;
            grid-template-columns:repeat(12, 1fr);
            gap: 16px
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px
        }

        .kvs {
            display: grid;
            grid-template-columns:180px 1fr;
            row-gap: 10px;
            column-gap: 12px
        }

        .key {
            color: var(--muted)
        }

        .val {
            font-weight: 600
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            text-align: left
        }

        th {
            background: #fafafa;
            font-size: 14px
        }

        .section {
            margin-top: 24px
        }

        .section > h2 {
            font-size: 18px;
            margin: 0 0 10px
        }

        .muted {
            color: var(--muted)
        }

        .signatures {
            display: grid;
            grid-template-columns:repeat(2, 1fr);
            gap: 24px
        }

        .sig-line {
            margin-top: 40px;
            border-top: 1px solid var(--border);
            padding-top: 6px;
            font-weight: 600
        }

        .footnote {
            margin-top: 24px;
            font-size: 12px;
            color: var(--muted)
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #e0e7ff
        }

        .right {
            text-align: right
        }

        .nowrap {
            white-space: nowrap
        }

        .break-avoid {
            break-inside: avoid
        }

        @media print {
            .toolbar {
                display: none
            }

            body {
                background: white
            }

            .page {
                box-shadow: none;
                border: none;
                margin: 0;
                border-radius: 0;
                page-break-after: always
            }

            a[href]:after {
                content: ""
            }
        }

        /* Styles cho ƒë·∫°i di·ªán k√Ω */
        .signed-notice {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .signed-notice h3 {
            color: #0c4a6e;
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .signed-notice p {
            margin: 8px 0;
            color: #0c4a6e;
        }

        .proxy-signature-info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .proxy-signature-info h4 {
            color: #92400e;
            margin: 0 0 10px 0;
        }

        .proxy-signature-info ul {
            margin: 10px 0;
            padding-left: 20px;
            color: #92400e;
        }

        .sign-button-proxy {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
        }

        .sign-button-proxy:hover {
            background: #b91c1c;
        }

        /* Styles cho ƒë√≥ng ti·ªÅn c·ªçc */
        .deposit-info {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .deposit-info h3 {
            color: #166534;
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .deposit-info p {
            margin: 8px 0;
            color: #166534;
        }

        .pay-button {
            background: #22c55e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }

        .pay-button:hover {
            background: #16a34a;
        }

        .status-pending {
            color: #f59e0b;
            font-weight: 600;
        }

        .status-paid {
            color: #22c55e;
            font-weight: 600;
        }

        .status-refunded {
            color: #6b7280;
            font-weight: 600;
        }

        .deposit-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .member-deposit-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .member-deposit-card h4 {
            margin: 0 0 10px 0;
            color: #374151;
        }

        .member-deposit-card .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .member-deposit-card .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .member-deposit-card .status.paid {
            background: #dcfce7;
            color: #166534;
        }
    </style>
</head>
<body>
<!-- Top toolbar (won't print) -->
<div class="toolbar">
    <button class="btn" onclick="fillDemo()">‚ú® ƒê·ªï d·ªØ li·ªáu m·∫´u</button>
    <button class="btn" onclick="loadContractData(1)">üìÑ Load t·ª´ Server</button>
    <button class="btn primary sign-button-proxy" id="sign-button" onclick="signContract()">‚úÖ K√Ω h·ª£p ƒë·ªìng (ƒê·∫°i di·ªán cho
        t·∫•t c·∫£ th√†nh vi√™n)
    </button>
    <button class="btn" onclick="checkDepositStatus()">üí∞ Ki·ªÉm tra ti·ªÅn c·ªçc</button>
    <button class="btn" onclick="clearAll()">‚ôªÔ∏è X√≥a d·ªØ li·ªáu</button>
    <span class="muted">M·∫πo: Admin Group c√≥ th·ªÉ k√Ω thay cho t·∫•t c·∫£ th√†nh vi√™n.</span>
</div>

<!-- Th√¥ng tin ƒë·∫°i di·ªán k√Ω -->
<div id="signed-info" style="display: none;"></div>

<!-- Th√¥ng tin ti·ªÅn c·ªçc -->
<div id="deposit-status"></div>

<!-- Th√¥ng tin ph√°p l√Ω v·ªÅ ƒë·∫°i di·ªán k√Ω -->
<div class="proxy-signature-info">
    <h4>üìã Th√¥ng tin v·ªÅ ƒë·∫°i di·ªán k√Ω</h4>
    <ul>
        <li><strong>Quy·ªÅn ƒë·∫°i di·ªán:</strong> Admin Group c√≥ quy·ªÅn k√Ω h·ª£p ƒë·ªìng thay cho t·∫•t c·∫£ th√†nh vi√™n</li>
        <li><strong>Gi√° tr·ªã ph√°p l√Ω:</strong> Ch·ªØ k√Ω ƒë·∫°i di·ªán c√≥ gi√° tr·ªã t∆∞∆°ng ƒë∆∞∆°ng v·ªõi ch·ªØ k√Ω c·ªßa t·ª´ng th√†nh vi√™n</li>
        <li><strong>Tr√°ch nhi·ªám:</strong> Admin Group ch·ªãu tr√°ch nhi·ªám v·ªÅ vi·ªác k√Ω h·ª£p ƒë·ªìng</li>
        <li><strong>Th√¥ng b√°o:</strong> T·∫•t c·∫£ th√†nh vi√™n s·∫Ω ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ vi·ªác k√Ω h·ª£p ƒë·ªìng</li>
    </ul>
</div>

<!-- Th√¥ng tin v·ªÅ ti·ªÅn c·ªçc -->
<div class="proxy-signature-info">
    <h4>üí∞ Th√¥ng tin v·ªÅ ti·ªÅn c·ªçc</h4>
    <ul>
        <li><strong>ƒêi·ªÅu ki·ªán:</strong> Ch·ªâ c√≥ th·ªÉ ƒë√≥ng ti·ªÅn c·ªçc sau khi contract ƒë√£ ƒë∆∞·ª£c k√Ω</li>
        <li><strong>S·ªë ti·ªÅn:</strong> Theo quy ƒë·ªãnh trong contract (th∆∞·ªùng l√† 2-5 tri·ªáu VND)</li>
        <li><strong>Ph∆∞∆°ng th·ª©c:</strong> Thanh to√°n qua VNPay</li>
        <li><strong>K√≠ch ho·∫°t:</strong> Group s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t khi t·∫•t c·∫£ th√†nh vi√™n ƒë√£ ƒë√≥ng ti·ªÅn c·ªçc</li>
    </ul>
</div>

<!-- A4-like page -->
<div class="page" id="contract">
    <header>
        <div class="logo">
            <div class="logo-mark" aria-hidden="true"></div>
            <div>
                <div>EVShare</div>
                <div class="subtitle">H·ªá th·ªëng ƒë·ªìng s·ªü h·ªØu xe ƒëi·ªán</div>
            </div>
        </div>
        <div class="right">
            <div class="badge" id="contract-status">DRAFT</div>
            <br/>
            <small class="muted">S·ªë h·ª£p ƒë·ªìng: <span data-text="contract.number">‚Äî</span></small>
        </div>
    </header>

    <h1>H·ª¢P ƒê·ªíNG S·ªû H·ªÆU XE CHUNG</h1>
    <div class="subtitle">CƒÉn c·ª© theo th·ªèa thu·∫≠n gi·ªØa c√°c B√™n thu·ªôc Nh√≥m s·ªü h·ªØu <b data-text="group.name">‚Äî</b>.</div>

    <!-- Meta blocks -->
    <div class="grid" style="margin-top:16px">
        <div class="card break-avoid" style="grid-column: span 7">
            <div class="meta"><strong>Th√¥ng tin ph∆∞∆°ng ti·ªán</strong></div>
            <div class="kvs" style="margin-top:10px">
                <div class="key">H√£ng / Model</div>
                <div class="val" data-text="vehicle.model">‚Äî</div>
                <div class="key">Bi·ªÉn s·ªë</div>
                <div class="val" data-text="vehicle.plate">‚Äî</div>
                <div class="key">S·ªë VIN</div>
                <div class="val" data-text="vehicle.vin">‚Äî</div>
            </div>
        </div>
        <div class="card break-avoid" style="grid-column: span 5">
            <div class="meta"><strong>Hi·ªáu l·ª±c h·ª£p ƒë·ªìng</strong></div>
            <div class="kvs" style="margin-top:10px">
                <div class="key">Ng√†y hi·ªáu l·ª±c</div>
                <div class="val" data-text="contract.effectiveDate">‚Äî</div>
                <div class="key">Ng√†y k·∫øt th√∫c</div>
                <div class="val" data-text="contract.endDate">‚Äî</div>
                <div class="key">K·ª≥ h·∫°n</div>
                <div class="val" data-text="contract.termLabel">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- Owners table -->
    <div class="section break-avoid">
        <h2>1. C√°c B√™n ƒë·ªìng s·ªü h·ªØu</h2>
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>H·ªç t√™n</th>
                <th>Li√™n h·ªá</th>
                <th>Gi·∫•y t·ªù</th>
                <th class="right">T·ª∑ l·ªá (%)</th>
            </tr>
            </thead>
            <tbody id="owners-tbody">
            <!-- injected rows -->
            </tbody>
        </table>
        <div class="muted" style="margin-top:6px">T·ªïng t·ª∑ l·ªá: <b><span id="ownership-sum">0</span>%</b></div>
    </div>

    <!-- Finance terms -->
    <div class="section">
        <h2>2. G√≥p v·ªën & Qu·ªπ v·∫≠n h√†nh</h2>
        <div class="kvs" style="margin-top:6px">
            <div class="key">Gi√° tr·ªã xe</div>
            <div class="val nowrap" data-text="finance.vehiclePrice">‚Äî</div>
            <div class="key">Ti·ªÅn c·ªçc</div>
            <div class="val nowrap" data-text="finance.depositAmount">‚Äî</div>
            <div class="key">M·ª•c ti√™u qu·ªπ</div>
            <div class="val nowrap" data-text="finance.targetAmount">‚Äî</div>
            <div class="key">Nguy√™n t·∫Øc g√≥p</div>
            <div class="val" data-text="finance.contributionRule">‚Äî</div>
        </div>
        <p class="muted">C√°c kho·∫£n chi b·∫£o d∆∞·ª°ng, s·∫°c, v·ªá sinh‚Ä¶ ƒë∆∞·ª£c thanh to√°n t·ª´ Qu·ªπ chung; kho·∫£n c√° nh√¢n (n·∫øu c√≥) do
            c√° nh√¢n chi tr·∫£ theo b√∫t to√°n b√π tr·ª´.</p>
        <p class="muted"><strong>L∆∞u √Ω:</strong> Ti·ªÅn c·ªçc ph·∫£i ƒë∆∞·ª£c ƒë√≥ng ƒë·∫ßy ƒë·ªß tr∆∞·ªõc khi h·ª£p ƒë·ªìng ƒë∆∞·ª£c k√≠ch ho·∫°t v√† c√≥
            hi·ªáu l·ª±c.</p>
    </div>

    <!-- Usage & rules -->
    <div class="section">
        <h2>3. Quy·ªÅn s·ª≠ d·ª•ng & L·ªãch ƒë·∫∑t</h2>
        <p>Vi·ªác s·ª≠ d·ª•ng xe ƒë∆∞·ª£c th·ª±c hi·ªán th√¥ng qua h·ªá th·ªëng ƒë·∫∑t l·ªãch. Quy t·∫Øc ∆∞u ti√™n: <span
                data-text="usage.rule">‚Äî</span>. M·ªói B√™n cam k·∫øt tu√¢n th·ªß l·ªãch ƒë·∫∑t v√† ho√†n tr·∫£ ƒë√∫ng h·∫πn.</p>
    </div>

    <div class="section">
        <h2>4. B·∫£o d∆∞·ª°ng, S·ª≠a ch·ªØa & B·∫£o hi·ªÉm</h2>
        <p>Xe ƒë∆∞·ª£c b·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥ theo khuy·∫øn ngh·ªã c·ªßa h√£ng. Tr√°ch nhi·ªám ph√™ duy·ªát chi ph√≠: <span
                data-text="maintenance.approval">‚Äî</span>. H·ª£p ƒë·ªìng b·∫£o hi·ªÉm: <span
                data-text="maintenance.insurance">‚Äî</span>.</p>
    </div>

    <div class="section">
        <h2>5. Gi·∫£i quy·∫øt tranh ch·∫•p</h2>
        <p>Tranh ch·∫•p ph√°t sinh ƒë∆∞·ª£c ghi nh·∫≠n tr√™n h·ªá th·ªëng v√† ∆∞u ti√™n h√≤a gi·∫£i trong Nh√≥m. C∆° ch·∫ø bi·ªÉu quy·∫øt: <span
                data-text="dispute.voting">‚Äî</span>. Th·∫©m quy·ªÅn cu·ªëi c√πng theo ph√°p lu·∫≠t hi·ªán h√†nh.</p>
    </div>

    <div class="section">
        <h2>6. ƒêi·ªÅu kho·∫£n chung</h2>
        <ul>
            <li>H·ª£p ƒë·ªìng c√≥ hi·ªáu l·ª±c khi t·∫•t c·∫£ B√™n ƒë·ªìng s·ªü h·ªØu ƒë·ªìng √Ω v√† k√Ω.</li>
            <li><strong>K√≠ch ho·∫°t h·ª£p ƒë·ªìng:</strong> Sau khi k√Ω, h·ª£p ƒë·ªìng ch·ªâ ƒë∆∞·ª£c k√≠ch ho·∫°t khi t·∫•t c·∫£ th√†nh vi√™n ƒë√£
                ƒë√≥ng ƒë·ªß ti·ªÅn c·ªçc theo quy ƒë·ªãnh.
            </li>
            <li><strong>Duy·ªát h·ª£p ƒë·ªìng:</strong> H·ªá th·ªëng s·∫Ω duy·ªát l·∫°i h·ª£p ƒë·ªìng sau khi nh·∫≠n ƒë·ªß ti·ªÅn c·ªçc t·ª´ t·∫•t c·∫£ th√†nh
                vi√™n.
            </li>
            <li>C√°c ph·ª• l·ª•c (n·∫øu c√≥) l√† b·ªô ph·∫≠n kh√¥ng t√°ch r·ªùi c·ªßa H·ª£p ƒë·ªìng.</li>
            <li>H·ªá th·ªëng l∆∞u v·∫øt phi√™n b·∫£n, th·ªùi ƒëi·ªÉm k√Ω v√† danh t√≠nh ng∆∞·ªùi k√Ω.</li>
        </ul>
    </div>

    <!-- Signatures -->
    <div class="section break-avoid">
        <h2>7. Ch·ªØ k√Ω c√°c B√™n</h2>
        <div id="signature-grid" class="signatures">
            <!-- signature boxes injected here -->
        </div>
        <div class="footnote">Khi k√Ω ƒëi·ªán t·ª≠, m·ªói √¥ ch·ªØ k√Ω s·∫Ω hi·ªÉn th·ªã t√™n, th·ªùi gian k√Ω v√† fingerprint c·ªßa ch·ªØ k√Ω.
        </div>
    </div>

    <div class="section" style="margin-top:28px">
        <div class="muted">ƒê·ªãa ƒëi·ªÉm k√Ω: <span data-text="contract.location">‚Äî</span> ¬∑ Ng√†y: <span
                data-text="contract.signDate">‚Äî</span></div>
    </div>
</div>

<script>
    // --- Tiny binding helper -------------------------------------------------
    function setText(selectorKey, value) {
        document.querySelectorAll(`[data-text="${selectorKey}"]`).forEach(el => el.textContent = value ?? '‚Äî');
    }

    function fmtCurrency(v) {
        if (v == null) return '‚Äî';
        try {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(v);
        } catch {
            return String(v);
        }
    }

    function render(data) {
        // Contract meta
        setText('contract.number', data.contract.number);
        setText('group.name', data.group.name);
        setText('vehicle.model', data.vehicle.model);
        setText('vehicle.plate', data.vehicle.plate);
        setText('vehicle.vin', data.vehicle.vin);
        setText('contract.effectiveDate', data.contract.effectiveDate);
        setText('contract.endDate', data.contract.endDate);
        setText('contract.termLabel', data.contract.termLabel);
        setText('contract.location', data.contract.location);
        setText('contract.signDate', data.contract.signDate);

        // Finance
        setText('finance.vehiclePrice', fmtCurrency(data.finance.vehiclePrice));
        setText('finance.depositAmount', fmtCurrency(data.finance.depositAmount));
        setText('finance.targetAmount', fmtCurrency(data.finance.targetAmount));
        setText('finance.fundAccount', data.finance.fundAccount);
        setText('finance.contributionRule', data.finance.contributionRule);

        // Usage / Maintenance / Dispute
        setText('usage.rule', data.usage.rule);
        setText('maintenance.approval', data.maintenance.approval);
        setText('maintenance.insurance', data.maintenance.insurance);
        setText('dispute.voting', data.dispute.voting);

        // Status badge
        const badge = document.getElementById('contract-status');
        badge.textContent = (data.contract.status || 'DRAFT').toUpperCase();

        // Owners
        const tbody = document.getElementById('owners-tbody');
        tbody.innerHTML = '';
        let sum = 0;
        (data.owners || []).forEach((o, i) => {
            sum += Number(o.share || 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${i + 1}</td>
          <td><strong>${o.name}</strong></td>
          <td>${o.phone || ''}${o.email ? ' ¬∑ ' + o.email : ''}</td>
          <td>${o.idType || ''} ${o.idNo || ''}</td>
          <td class="right">${(o.share ?? 0)}%</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('ownership-sum').textContent = sum;

        // Signatures grid: only group admin
        const grid = document.getElementById('signature-grid');
        grid.innerHTML = '';
        const admin = (data.owners || [])[0];
        if (admin) {
            const box = document.createElement('div');
            box.className = 'sig-box';

            // Ki·ªÉm tra tr·∫°ng th√°i ƒë√£ k√Ω
            const isSigned = data.contract.status === 'SIGNED';
            const signatureText = isSigned ? '‚úÖ ƒê√£ k√Ω' : 'Ch·ªØ k√Ω';
            const signatureStyle = isSigned ? 'color: #166534; font-weight: bold;' : '';

            box.innerHTML = `
          <div><strong>${admin.name}</strong></div>
          <div class="muted">ƒê·∫°i di·ªán Nh√≥m (Admin)</div>
          <div class="sig-line" style="${signatureStyle}">${signatureText}</div>
          <div class="muted" style="font-size:12px">T·ª∑ l·ªá: ${admin.share ?? 0}%</div>`;
            grid.appendChild(box);
        }
    }

    // Function ƒë·ªÉ load data t·ª´ server
    function loadContractData(groupId) {
        fetch(`/api/contracts/${groupId}`)
            .then(response => response.json())
            .then(data => {
                // Convert server data to template format
                const templateData = convertServerDataToTemplate(data);
                render(templateData);
            })
            .catch(error => {
                console.error('Error loading contract data:', error);
                // Fallback to demo data
                fillDemo();
            });
    }

    // Convert server data to template format
    function convertServerDataToTemplate(serverData) {
        return {
            contract: {
                number: serverData.contractNumber || 'EVS-001',
                effectiveDate: serverData.startDate || '2025-01-01',
                endDate: serverData.endDate || '2026-01-01',
                termLabel: '12 th√°ng',
                location: 'H√† N·ªôi',
                signDate: new Date().toISOString().split('T')[0],
                status: serverData.isActive ? 'ACTIVE' : 'DRAFT'
            },
            group: {
                name: serverData.groupName || 'EVShare Group'
            },
            vehicle: {
                model: 'VinFast VF 8 Plus',
                plate: '30A-123.45',
                vin: 'RLVZZZ1EZBW000001'
            },
            finance: {
                vehiclePrice: 950000000,
                depositAmount: serverData.requiredDepositAmount || 2000000,
                targetAmount: 50000000,
                fundAccount: 'MB Bank 0123456789',
                contributionRule: 'Theo t·ª∑ l·ªá s·ªü h·ªØu'
            },
            usage: {
                rule: 'ƒêi·ªÉm t√≠n d·ª•ng l·ªãch s·ª≠ & phi√™n b·ªëc thƒÉm tu·∫ßn'
            },
            maintenance: {
                approval: 'Bi·ªÉu quy·∫øt > 50% theo t·ª∑ l·ªá s·ªü h·ªØu cho chi > 5 tri·ªáu',
                insurance: 'PVI ‚Äì G√≥i v·∫≠t ch·∫•t to√†n di·ªán'
            },
            dispute: {
                voting: 'ƒêa s·ªë theo t·ª∑ l·ªá s·ªü h·ªØu; n·∫øu ho√† 50/50, ∆∞u ti√™n l·ªãch s·ª≠ ƒë√≥ng g√≥p'
            },
            owners: [
                {
                    name: 'Nguy·ªÖn VƒÉn A',
                    phone: '0901 234 567',
                    email: 'a@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678901',
                    share: 40
                },
                {
                    name: 'Tr·∫ßn Th·ªã B',
                    phone: '0902 234 567',
                    email: 'b@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678902',
                    share: 35
                },
                {
                    name: 'L√™ VƒÉn C',
                    phone: '0903 234 567',
                    email: 'c@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678903',
                    share: 25
                }
            ]
        };
    }

    // --- Demo & helpers ------------------------------------------------------
    function fillDemo() {
        const demo = {
            contract: {
                number: 'EVS-2025-001',
                effectiveDate: '2025-10-20',
                endDate: '2026-10-19',
                termLabel: '12 th√°ng',

                status: 'Draft',
                location: 'H√† N·ªôi',
                signDate: '2025-10-20'
            },
            group: {name: 'EVShare ‚Äì Nh√≥m A'},
            vehicle: {model: 'VinFast VF 8 Plus', plate: '30A-123.45', vin: 'RLVZZZ1EZBW000001'},
            finance: {
                vehiclePrice: 950_000_000,
                depositAmount: 30_000_000,
                targetAmount: 50_000_000,
                fundAccount: 'MB Bank 0123456789 ‚Äì EVShare Group A',
                contributionRule: 'Theo t·ª∑ l·ªá s·ªü h·ªØu'
            },
            usage: {rule: 'ƒêi·ªÉm t√≠n d·ª•ng l·ªãch s·ª≠ & phi√™n b·ªëc thƒÉm tu·∫ßn'},
            maintenance: {
                approval: 'Bi·ªÉu quy·∫øt > 50% theo t·ª∑ l·ªá s·ªü h·ªØu cho chi > 5 tri·ªáu',
                insurance: 'PVI ‚Äì G√≥i v·∫≠t ch·∫•t to√†n di·ªán'
            },
            dispute: {voting: 'ƒêa s·ªë theo t·ª∑ l·ªá s·ªü h·ªØu; n·∫øu ho√† 50/50, ∆∞u ti√™n l·ªãch s·ª≠ ƒë√≥ng g√≥p'},
            owners: [
                {
                    name: 'Nguy·ªÖn VƒÉn A',
                    phone: '0901 234 567',
                    email: 'a@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678901',
                    share: 40
                },
                {
                    name: 'Tr·∫ßn Th·ªã B',
                    phone: '0902 234 567',
                    email: 'b@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678902',
                    share: 35
                },
                {
                    name: 'L√™ VƒÉn C',
                    phone: '0903 234 567',
                    email: 'c@evshare.vn',
                    idType: 'CCCD',
                    idNo: '012345678903',
                    share: 25
                }
            ]
        };
        render(demo);
    }

    // Function ƒë·ªÉ k√Ω h·ª£p ƒë·ªìng (Admin Group k√Ω thay t·∫•t c·∫£ Members)
    function signContract() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k√Ω h·ª£p ƒë·ªìng n√†y thay cho t·∫•t c·∫£ th√†nh vi√™n? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
            // L·∫•y groupId t·ª´ URL ho·∫∑c t·ª´ data hi·ªán t·∫°i
            const groupId = getCurrentGroupId();

            // L·∫•y th√¥ng tin admin hi·ªán t·∫°i
            const adminName = getCurrentAdminName();

            // G·ªçi API ƒë·ªÉ k√Ω h·ª£p ƒë·ªìng v·ªõi ƒë·∫°i di·ªán
            fetch(`/api/contracts/${groupId}/sign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    signedAt: new Date().toISOString(),
                    signature: 'Digital signature by admin',
                    adminName: adminName,
                    signatureType: 'ADMIN_PROXY',
                    reason: 'Admin Group k√Ω thay t·∫•t c·∫£ th√†nh vi√™n theo quy ƒë·ªãnh'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ H·ª£p ƒë·ªìng ƒë√£ ƒë∆∞·ª£c k√Ω th√†nh c√¥ng!\n' +
                            'Ng∆∞·ªùi k√Ω: ' + data.signedBy + '\n' +
                            'Lo·∫°i k√Ω: ' + data.signatureType + '\n' +
                            'Th·ªùi gian: ' + new Date(data.signedAt).toLocaleString());
                        // C·∫≠p nh·∫≠t UI ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i ƒë√£ k√Ω
                        updateContractStatus('SIGNED');
                        // Reload data ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                        loadContractData(groupId);
                    } else {
                        alert('‚ùå C√≥ l·ªói x·∫£y ra khi k√Ω h·ª£p ƒë·ªìng: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error signing contract:', error);
                    alert('‚ùå C√≥ l·ªói x·∫£y ra khi k√Ω h·ª£p ƒë·ªìng. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }
    }

    // Function ƒë·ªÉ l·∫•y t√™n admin hi·ªán t·∫°i
    function getCurrentAdminName() {
        // C√≥ th·ªÉ l·∫•y t·ª´ user info ho·∫∑c t·ª´ data hi·ªán t·∫°i
        const userInfo = getCurrentUserInfo();
        return userInfo ? userInfo.fullName : 'Admin Group';
    }

    // Function ƒë·ªÉ l·∫•y th√¥ng tin user hi·ªán t·∫°i
    function getCurrentUserInfo() {
        // C√≥ th·ªÉ l·∫•y t·ª´ localStorage, sessionStorage ho·∫∑c t·ª´ API
        try {
            const userInfo = localStorage.getItem('userInfo');
            return userInfo ? JSON.parse(userInfo) : null;
        } catch (e) {
            return null;
        }
    }

    // Function ƒë·ªÉ ƒë√≥ng ti·ªÅn c·ªçc
    function payDeposit() {
        const groupId = getCurrentGroupId();
        const userId = getCurrentUserId();

        // L·∫•y th√¥ng tin deposit
        fetch(`/api/deposits/info/${userId}/${groupId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.canPay) {
                    alert('‚ùå B·∫°n kh√¥ng th·ªÉ ƒë√≥ng ti·ªÅn c·ªçc:\n' +
                        '- Contract ch∆∞a ƒë∆∞·ª£c k√Ω: ' + (data.contractSigned ? 'ƒê√£ k√Ω' : 'Ch∆∞a k√Ω') + '\n' +
                        '- Tr·∫°ng th√°i deposit: ' + data.depositStatus);
                    return;
                }

                const amount = data.requiredAmount;
                const confirmMessage = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng ti·ªÅn c·ªçc?\n\n` +
                    `S·ªë ti·ªÅn: ${formatCurrency(amount)}\n` +
                    `Ph∆∞∆°ng th·ª©c: VNPay\n` +
                    `L∆∞u √Ω: Sau khi ƒë√≥ng ti·ªÅn c·ªçc, b·∫°n s·∫Ω tr·ªü th√†nh th√†nh vi√™n ch√≠nh th·ª©c c·ªßa group.`;

                if (confirm(confirmMessage)) {
                    createDepositPayment(userId, groupId, amount);
                }
            })
            .catch(error => {
                console.error('Error getting deposit info:', error);
                alert('‚ùå C√≥ l·ªói khi l·∫•y th√¥ng tin deposit. Vui l√≤ng th·ª≠ l·∫°i.');
            });
    }

    // Function ƒë·ªÉ t·∫°o payment v·ªõi VNPay
    function createDepositPayment(userId, groupId, amount) {
        const request = {
            userId: userId,
            groupId: groupId,
            amount: amount,
            paymentMethod: 'VNPAY'
        };

        fetch('/api/deposits/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        })
            .then(response => response.json())
            .then(data => {
                if (data.paymentId && data.vnpayUrl) {
                    alert('‚úÖ T·∫°o payment th√†nh c√¥ng!\n' +
                        'Payment ID: ' + data.paymentId + '\n' +
                        'S·ªë ti·ªÅn: ' + formatCurrency(data.amount) + '\n' +
                        'Tr·∫°ng th√°i: ' + data.status + '\n\n' +
                        'ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay...');

                    // Redirect tr·ª±c ti·∫øp ƒë·∫øn VNPay
                    window.location.href = data.vnpayUrl;
                } else {
                    alert('‚ùå C√≥ l·ªói khi t·∫°o payment: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating deposit payment:', error);
                alert('‚ùå C√≥ l·ªói khi t·∫°o payment. Vui l√≤ng th·ª≠ l·∫°i.');
            });
    }

    // Function ƒë·ªÉ ki·ªÉm tra payment status sau khi quay l·∫°i t·ª´ VNPay
    function checkPaymentStatusFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const responseCode = urlParams.get('vnp_ResponseCode');

        if (responseCode) {
            if (responseCode === '00') {
                alert('üéâ Thanh to√°n th√†nh c√¥ng!\n' +
                    'Ti·ªÅn c·ªçc ƒë√£ ƒë∆∞·ª£c ƒë√≥ng th√†nh c√¥ng.\n' +
                    'Group s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t khi t·∫•t c·∫£ th√†nh vi√™n ƒë√£ ƒë√≥ng ti·ªÅn c·ªçc.');

                // Reload ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                alert('‚ùå Thanh to√°n th·∫•t b·∫°i!\n' +
                    'M√£ l·ªói: ' + responseCode + '\n' +
                    'Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
    }

    // Function ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i deposit
    function checkDepositStatus() {
        const groupId = getCurrentGroupId();
        const userId = getCurrentUserId();

        fetch(`/api/deposits/info/${userId}/${groupId}`)
            .then(response => response.json())
            .then(data => {
                updateDepositStatusUI(data);

                // N·∫øu ƒë√£ ƒë√≥ng ti·ªÅn c·ªçc, ki·ªÉm tra group activation
                if (data.depositStatus === 'PAID') {
                    checkGroupActivation(groupId);
                }
            })
            .catch(error => {
                console.error('Error checking deposit status:', error);
            });
    }

    // Function ƒë·ªÉ c·∫≠p nh·∫≠t UI tr·∫°ng th√°i deposit
    function updateDepositStatusUI(data) {
        const depositStatusElement = document.getElementById('deposit-status');
        if (depositStatusElement) {
            depositStatusElement.innerHTML = `
                <div class="deposit-info">
                    <h3>üí∞ Th√¥ng tin ti·ªÅn c·ªçc</h3>
                    <p><strong>T·ª∑ l·ªá s·ªü h·ªØu:</strong> ${data.ownershipPercentage || 0}%</p>
                    <p><strong>S·ªë ti·ªÅn c·∫ßn ƒë√≥ng:</strong> ${formatCurrency(data.requiredAmount)}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong> 
                        <span class="status-${data.depositStatus.toLowerCase()}">${getDepositStatusText(data.depositStatus)}</span>
                    </p>
                    <p><strong>Contract ƒë√£ k√Ω:</strong> ${data.contractSigned ? '‚úÖ C√≥' : '‚ùå Ch∆∞a'}</p>
                    <p class="muted"><small>üí° Ti·ªÅn c·ªçc ƒë∆∞·ª£c t√≠nh theo t·ª∑ l·ªá s·ªü h·ªØu c·ªßa b·∫°n</small></p>
                    ${data.canPay ? '<button onclick="payDeposit()" class="pay-button">üí≥ ƒê√≥ng ti·ªÅn c·ªçc</button>' : ''}
                </div>
            `;
        }
    }

    // Function ƒë·ªÉ ki·ªÉm tra group activation
    function checkGroupActivation(groupId) {
        fetch(`/api/deposits/group/${groupId}/status`)
            .then(response => response.json())
            .then(data => {
                const allPaid = data.every(member => member.depositStatus === 'PAID');

                if (allPaid) {
                    alert('üéâ T·∫•t c·∫£ th√†nh vi√™n ƒë√£ ƒë√≥ng ti·ªÅn c·ªçc!\n' +
                        'Group s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t t·ª± ƒë·ªông.');

                    // Reload page ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking group activation:', error);
            });
    }

    // Function ƒë·ªÉ l·∫•y user ID hi·ªán t·∫°i
    function getCurrentUserId() {
        // C√≥ th·ªÉ l·∫•y t·ª´ localStorage, sessionStorage ho·∫∑c t·ª´ API
        try {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                return user.userId || user.id;
            }
        } catch (e) {
            console.error('Error getting user info:', e);
        }
        return 1; // Default for demo
    }

    // Function ƒë·ªÉ format currency
    function formatCurrency(amount) {
        if (!amount) return '0 VND';
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    // Function ƒë·ªÉ l·∫•y text tr·∫°ng th√°i deposit
    function getDepositStatusText(status) {
        switch (status) {
            case 'PENDING':
                return '‚è≥ Ch∆∞a ƒë√≥ng';
            case 'PAID':
                return '‚úÖ ƒê√£ ƒë√≥ng';
            case 'REFUNDED':
                return 'üîÑ ƒê√£ ho√†n';
            default:
                return '‚ùì Kh√¥ng x√°c ƒë·ªãnh';
        }
    }

    // Function ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i contract tr√™n UI
    function updateContractStatus(status) {
        const statusElement = document.getElementById('contract-status');
        if (statusElement) {
            statusElement.textContent = status;
            statusElement.className = 'status-' + status.toLowerCase();
        }

        // ·∫®n n√∫t k√Ω n·∫øu ƒë√£ k√Ω
        const signButton = document.getElementById('sign-button');
        if (signButton && status === 'SIGNED') {
            signButton.style.display = 'none';

            // Hi·ªÉn th·ªã th√¥ng tin ƒë√£ k√Ω
            const signedInfo = document.getElementById('signed-info');
            if (signedInfo) {
                signedInfo.style.display = 'block';
                signedInfo.innerHTML = `
                    <div class="signed-notice">
                        <h3>‚úÖ H·ª£p ƒë·ªìng ƒë√£ ƒë∆∞·ª£c k√Ω</h3>
                        <p><strong>Ng∆∞·ªùi k√Ω:</strong> Admin Group (ƒê·∫°i di·ªán cho t·∫•t c·∫£ th√†nh vi√™n)</p>
                        <p><strong>Th·ªùi gian:</strong> <span id="signed-time">ƒêang t·∫£i...</span></p>
                        <p><strong>Lo·∫°i k√Ω:</strong> ƒê·∫°i di·ªán ph√°p l√Ω</p>
                    </div>
                `;

                // C·∫≠p nh·∫≠t th·ªùi gian k√Ω
                const signedTimeElement = document.getElementById('signed-time');
                if (signedTimeElement) {
                    signedTimeElement.textContent = new Date().toLocaleString();
                }
            }
        }
    }

    // Auto demo on first load for preview
    fillDemo();

    // Ki·ªÉm tra payment status t·ª´ URL khi load page
    checkPaymentStatusFromUrl();
</script>
</body>
</html>
